<html><head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <style>
        body {
            background-color: #cccccc;
            font-family: verdana, tahoma, geneva, sans-serif;
        }

        p {
            line-height: 2.0;
        }

        a {
        	text-decoration: none
        }

        a:hover {
        	text-decoration: underline;
        }

        div.header {
            background: #30a080;
            padding-left: 6px;
        }

        div.op {
            background: #f2f2f2;
            border-radius: 20px;
            padding: 5px;
            margin-top: 20px;
            margin-left: 20px;
            margin-right: 20px;
            margin-bottom: 20px;
        }

        div.padded {
            padding: 5px;
        }

        div.hidden {
            display: none;
        }

        div.indent {
            margin-left: 40px;
        }

        div.scrollbox {
            height: 200px;
            overflow-y: scroll;
        }

        div.bubble {
            border-radius: 20px;
            border: 1px solid #808080;
            background: #ffffff;
            padding: 7px;
        }

        img.rounded {
            border-radius: 9px;
        }
    </style>
    <script type="text/javascript">
//<globals>//
let tag_lines = [
    "An anti-social network.<br>Foes are more interesting than friends anyway.",
    "Social media exists to validate your stupid ideas.<br>We exist to crush them.",
    "Got an opinion you can't back up?<br>Great, keep it to yourself.",
    "Hate criticism and love validation?<br>Go away. You're not welcome here.",
    "Love caps lock? Hate grammar Nazis?<br>Maybe Facebook is a better place for you.",
    "We're not here to spread alleged facts.<br>We're here to discuss reasons.",
    "As the pen is to the sword,<br>so debate is to war.",
];

var Sha256={};Sha256.hash=function(msg){msg=msg.utf8Encode();
var K=[0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,
0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,
0xe49b69c1,0xefbe4786,0x0fc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,
0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x06ca6351,0x14292967,
0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,
0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,
0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,
0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2];
var H=[0x6a09e667,0xbb67ae85,0x3c6ef372,0xa54ff53a,0x510e527f,0x9b05688c,0x1f83d9ab,0x5be0cd19];
msg+=String.fromCharCode(0x80);var l=msg.length/4+2;var N=Math.ceil(l/16);var M=new Array(N);
for(var i=0;i<N;i++){M[i]=new Array(16);for(var j=0;j<16;j++){
M[i][j]=(msg.charCodeAt(i*64+j*4)<<24)|(msg.charCodeAt(i*64+j*4+1)<<16)|
(msg.charCodeAt(i*64+j*4+2)<<8)|(msg.charCodeAt(i*64+j*4+3));}}
M[N-1][14]=((msg.length-1)*8) / Math.pow(2,32);M[N-1][14]=Math.floor(M[N-1][14]);
M[N-1][15]=((msg.length-1)*8)&0xffffffff;var W=new Array(64);var a,b,c,d,e,f,g,h;
for(var i=0;i<N;i++){for(var t=0;t<16;t++) W[t]=M[i][t];
for(var t=16;t<64;t++) W[t]=(Sha256.B1(W[t-2])+W[t-7]+Sha256.B0(W[t-15])+W[t-16])&0xffffffff;
a=H[0];b=H[1];c=H[2];d=H[3];e=H[4];f=H[5];g=H[6];h=H[7];for(var t=0;t<64;t++){
var T1=h+Sha256.A1(e)+Sha256.Ch(e,f,g)+K[t]+W[t];var T2=Sha256.A0(a)+Sha256.Maj(a,b,c);
h=g;g=f;f=e;e=(d+T1)&0xffffffff;d=c;c=b;b=a;a=(T1+T2)&0xffffffff;}
H[0]=(H[0]+a)&0xffffffff;H[1]=(H[1]+b)&0xffffffff;H[2]=(H[2]+c)&0xffffffff;H[3]=(H[3]+d)&0xffffffff;
H[4]=(H[4]+e)&0xffffffff;H[5]=(H[5]+f)&0xffffffff;H[6]=(H[6]+g)&0xffffffff;H[7]=(H[7]+h)&0xffffffff;}
return Sha256.toHex(H[0])+Sha256.toHex(H[1])+Sha256.toHex(H[2])+Sha256.toHex(H[3])+
Sha256.toHex(H[4])+Sha256.toHex(H[5])+Sha256.toHex(H[6])+Sha256.toHex(H[7]);};
Sha256.RO=function(n,x){return (x>>>n)|(x<<(32-n));};
Sha256.A0=function(x){return Sha256.RO(2, x)^Sha256.RO(13,x)^Sha256.RO(22,x);};
Sha256.A1=function(x){return Sha256.RO(6, x)^Sha256.RO(11,x)^Sha256.RO(25,x);};
Sha256.B0=function(x){return Sha256.RO(7, x)^Sha256.RO(18,x)^(x>>>3);};
Sha256.B1=function(x){return Sha256.RO(17,x)^Sha256.RO(19,x)^(x>>>10);};
Sha256.Ch=function(x,y,z){return (x&y)^(~x&z);};Sha256.Maj=function(x,y,z){return (x&y)^(x&z)^(y&z);};
Sha256.toHex=function(n){var s="",v;for(var i=7;i>=0;i--){v=(n>>>(i*4))&0xf;s+=v.toString(16);}
return s;};if(typeof String.prototype.utf8Encode=='undefined'){
String.prototype.utf8Encode=function(){return unescape(encodeURIComponent(this));};}
if(typeof String.prototype.utf8Decode=='undefined'){String.prototype.utf8Decode=function()
{try{return decodeURIComponent(escape(this));}catch(e){return this;}};}

function httpPost(url, payload, callback)
{
    let request = new XMLHttpRequest();
    request.onreadystatechange = function()
    {
        if(request.readyState == 4)
        {
            if(request.status == 200)
            callback(request.responseText);
            else
            {
                if(request.status == 0 && request.statusText.length == 0)
                    alert("Connection failed");
                else
                    alert("Server returned status " + request.status + ", " + request.statusText);
            }
        }
    };
    request.open('post', url, true);
    request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    request.send(payload);
}

function show_or_hide_new_account_div()
{
    let new_account_div = document.getElementById('new_account_div');
    let no_pw_warning = document.getElementById('no_pw_warning');
    if (isself && have_pw) {
        new_account_div.style.display = 'inline-block';
        no_pw_warning.style.display = 'none';
    } else {
        new_account_div.style.display = 'none';
        no_pw_warning.style.display = 'inline-block';
    }
}

function outgoing(payload)
{
    payload.session_id = session_id;
    httpPost("account_ajax.html", JSON.stringify(payload), incoming);
}

function incoming(response)
{
    let ob = JSON.parse(response);
    if (ob.alert !== undefined) {
        alert(`${ob.alert}`);
        return;
    }
    if (ob.have_pw !== undefined) {
        have_pw = ob.have_pw;
        show_or_hide_new_account_div();
    }
    if (ob.reload === true) {
        location.reload();
    }
    if (ob.comments_pos !== undefined) {
        comments_pos = ob.comments_pos;
    }
    if (ob.comments !== undefined) {
        receive_comments(ob.comments);
    }
}

function receive_comments(comments)
{
    let comments_list = document.getElementById('comments');
    for (let com of comments) {
        let item = document.createElement('li');
        item.innerHTML = `<a href="feed.html?post=${com[0]}">${com[1]}</a>`;
        comments_list.appendChild(item);
    }
}

function make_new_account()
{
    outgoing({
        'act': 'logout',
    })
}

function drop_account(index)
{
    outgoing({
        'act': 'drop_account',
        'index': index,
    })
    setTimeout(function() { location.reload(); }, 200);
}

function switch_account_by_name(account_name, password)
{
    outgoing({
        'act': 'switch',
        'name': account_name,
        'pw': password,
    })
}

function switch_account(index)
{
    let password = document.getElementById(`pw_${index}`).value;
    switch_account_by_name(account_names[index], password);
}

function pw_onkeyup(index, event)
{
    if (event.keyCode === 13) {
        switch_account(index);
    }
}

function switch_manual()
{
    let un = document.getElementById('manual_username');
    let pw = document.getElementById('pw_manual');
    if (un.value.length < 1) {
        alert('Please enter your username');
        un.focus();
        return;
    }
    switch_account_by_name(un.value, pw.value);
}

function get_updates()
{
    //outgoing({ act: 'update' });
}

function init()
{
    // Set the tag line
    let tagline = document.getElementById('tagline');
    tagline.innerHTML = tag_lines[Math.floor(Math.random() * tag_lines.length)];

    // Display basic info
    let s = []
    s.push(`<h1>${isself ? 'Your account' : 'Another user'}</h1>`);
    if (isself) {
        s.push('<p>(<b>Warning:</b> Do not hand out personally identifying information on the Internet.');
        s.push('We use A.I.. You don\'t want it showing up at your house (j/k).');
        s.push('Seriously, though, pseudonymns are cool here. This is a free web service,');
        s.push('not a bank account or a government program. Keep control over your personal information.)</p>');
    }
    s.push('<br><table><tr>');
    s.push(`<td>${isself ? 'Change your p' : 'P'}rofile picture: <img class="rounded" onclick='on_click_profile_pic()' src='${profile_pic}'></td>`);
    if (isself) {
        s.push(`<td valign='bottom'><form enctype="multipart/form-data" method="post" action="receive_image.html" id="profile_pic_form">`);
        s.push('<br><input id="browse_button" name="file" type="file" onchange="submit_profile_pic_form()">');
        s.push('</form></td>');
    }
    s.push('</tr></table>');
    s.push('<br><br>');
    if (isself) {
        s.push(`Change your user name: <input type='text' id='username' onkeydown='on_name_change()' onpaste='on_name_change()' value='${username}' maxlength='100'>`);
        s.push(`<div class='hidden' id='submit_name'> <button type="button" name='Submit' onclick='submit_name_change()'>Submit Change</button></div>`);
    } else {
        s.push(`<b>${username}</b>`);
    }
    s.push('<br><br><br>');
    if (isself) {
        s.push(`<div id="no_pw_warning" class='hidden'><font color="red">You currently have no password! You should probably fix that.</font></div>`);
        s.push(`<table><tr>`);
        s.push(`    <td style="text-align:right">Change your password:<br><small><small><br></small></small>Again:</td>`);
        s.push(`    <td>`);
        s.push(`        <input type='password' id='pw1' onkeydown='on_pw_change()' onpaste='on_pw_change()' value='' maxlength='100'><br>`);
        s.push(`        <input type='password' id='pw2' onkeydown='on_pw_change()' onpaste='on_pw_change()' value='' maxlength='100'>`);
        s.push(`    </td>`);
        s.push(`    <td valign='bottom'>`);
        s.push(`        <div class='hidden' id='submit_pw'>`);
        s.push(`            <button type="button" onclick='submit_pw_change()'>Submit Change</button>`);
        s.push(`        </div>`);
        s.push(`    </td>`);
        s.push(`</tr></table><br>`);
    }
    let basic_info_div = document.getElementById('basic_info');
    basic_info_div.innerHTML = s.join('');

    // Show log out link
    show_or_hide_new_account_div();

    // Fix up the back link
    let back_span = document.getElementById('back_link');
    if (prev_query.post !== undefined) {
        back_span.innerHTML = `<a href="feed.html?post=${prev_query.post}">Back to debates</a>`;
    }

    // Make the switch accounts div
    if (isself) {
        if (account_images.length != account_names.length) {
            throw 'Expected images and names to have the same length';
        }
        s = [];
        s.push('<h3>Switch account</h3>');
        s.push('<table>');
        for (let i = 0; i < account_names.length; i++) {
            if (account_names[i] == username)
                continue;
            s.push(`<tr><td><a onclick="drop_account(${i})" href="javascript:void(0);"><img src="starter_pics/trash.png"></a></td>`);
            s.push(`<td><a onclick="switch_account(${i})" href="javascript:void(0);">`);
            s.push(`<img class="rounded" src='${account_images[i]}'>`);
            s.push('</a></td><td>');
            s.push(`<b><a onclick="switch_account(${i})" href="javascript:void(0);">`);
            s.push(`${account_names[i]}</a></b></td>`);
            s.push(`<td>Password: <input type="text" id="pw_${i}" onkeyup="pw_onkeyup(${i}, event);" size=10></td>`);
            s.push('</tr>');
        }
        s.push('<tr><td></td><td>');
        s.push(`<a onclick="switch_manual()" href="javascript:void(0);">`);
        s.push('<img class="rounded" src="starter_pics/unknown.jpeg">');
        s.push('</a></td><td>');
        s.push('ID: <input type="text" id="manual_username" size=10>');
        s.push(`<td>Password: <input type="text" id="pw_manual" size=10></td>`);
        s.push('<td><tr>');
        let switch_account_div = document.getElementById('switch_account_div');
        switch_account_div.innerHTML = s.join('');
    }

    // Get comments
    request_updates();
}

function submit_profile_pic_form()
{
    let form = document.getElementById('profile_pic_form');
    form.submit();
    let bb = document.getElementById('browse_button');
    bb.value = null;
}

function on_click_profile_pic()
{
    if (isself)
        alert('Press the \'Browse\' button to change your profile picture');
}

function on_name_change()
{
    let b = document.getElementById('submit_name');
    b.style.display = 'inline-block';
}

function on_pw_change()
{
    let b = document.getElementById('submit_pw');
    b.style.display = 'inline-block';
}

function submit_name_change()
{
    let un = document.getElementById('username');
    let newname = un.value;
    if (newname.length < 2) {
        alert('Too short');
        return;
    }
    outgoing({
        'act': 'change_name',
        'name': newname,
    });
    let submit_div = document.getElementById('submit_name');
    submit_div.style.display = 'none';
}

function submit_pw_change()
{
    let pw1 = document.getElementById('pw1');
    let pw2 = document.getElementById('pw2');
    if (pw1.value != pw2.value) {
        alert('Passwords do not match! Not changed.');
        return;
    }
    outgoing({
        'act': 'change_pw',
        'pw': pw1.value,
    });
    let submit_div = document.getElementById('submit_pw');
    submit_div.style.display = 'none';
}

function request_updates()
{
    if (comments_pos > 0) {
        outgoing({
            act: 'update',
            comments_pos: comments_pos,
        });
    }
}

</script>

</head><body>
<br><br>
<table bgcolor=#dddddd width=800 align=center><tr><td>

<div class="header">
    <table><tr>
        <td width=400>
            <big><big><big><big>DebateStuff.com</big></big></big></big><br>
            <div id='tagline'></div>
        </td>
        <td>
            <span id='back_link'><a href="feed.html">Back to debates</a></span>
            &nbsp;&nbsp;&nbsp;
            <a href="handbook.html">Handbook</a>
            <br>
    </td>
    </tr></table>
</div>

<br>
<table cellpadding=40><tr><td>
<div id="basic_info"></div>
<div id="switch_account_div"></div>
<br>
<div class='hidden' id='new_account_div'><a onclick="make_new_account()" href="javascript:void(0);">Make a new account</a></div>

<br><br>
<h3>Your posts and comments:</h3>
<ul id='comments'></ul>

<br><br><br><br>
</td></tr></table>
</td></tr></table>
<br><br><br><br><br><br><br><br>

<script type="text/javascript">
init();
let timer = setInterval(function() { request_updates(); }, 5000);
</script>

</body></html>
