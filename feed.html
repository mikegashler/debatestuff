<html><head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <style>
        body {
            background-color: #104030;
            font-family: verdana, tahoma, geneva, sans-serif;
            font-size: 24px;
        }

        p {
            line-height: 1.6;
        }

        a {
        	text-decoration: none
        }

        a.good {
            color: #008000;
        }

        a.bad {
            color: #800000;
        }

        a:hover {
        	text-decoration: underline;
        }

        div.header {
            background: #50a090;
            padding-left: 6px;
        }

        div.op {
            background: #ffffff;
            border-radius: 20px;
            padding: 5px;
            margin-top: 20px;
            margin-left: 20px;
            margin-right: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        }

        div.notifs {
            background: #70c0b0;
            border-radius: 20px;
            margin-top: 20px;
            margin-left: 20px;
            margin-right: 20px;
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #004000;
        }

        tr.notif_unread {
            background-color: #90e0d0;
        }

        div.padded {
            padding: 5px;
        }

        .hidden {
            display: none;
        }

        div.indent {
            margin-left: 40px;
        }

        div.scrollbox {
            height: 200px;
            overflow-y: scroll;
        }

        div.rp_color {
            background: #f0f4f0;
        }

        div.rate_color {
            background: #f8f8e0;
        }

        div.bubble {
            border-radius: 20px;
            border: 1px solid #808080;
            padding: 7px;
        }

        img.rounded {
            border-radius: 9px;
        }

        .hovermenu {
          display: none;
        }

        .hovermenulink:hover .hovermenu {
          display: inline-block;
        }

        .tool {
        }

        .tool_anchor {
            position: relative;
            width: 0;
            height: 0;
        }

        .tool .tooltip {
            visibility: hidden;
            width: 350px;
            background-color: #d0b0a0;
            color: black;
            text-align: center;
            border-radius: 10px;
            border: 1px solid #808080;
            padding: 15px 5;
            z-index: 1;
            position: absolute;
            left: 30px;
            top: 20px;
        }

        .tool:hover .tooltip {
            visibility: visible;
        }
    </style>
    <script type="text/javascript" src="slider.js"></script>
    <script type="text/javascript" src="priority_queue.js"></script>
    <script type="text/javascript">
//<globals>//
let rev = 0;
let op_revs = [];
let children = {}; // Maps node ids to lists of child ids
let active_text_area = null;

let tag_lines = [
    "An anti-social network.<br>Friends are lame.<br>Foes teach you more.",
    "Social media exists to<br>validate your stupid ideas.<br>We exist to crush them.",
    "Got an opinion you can't back up?<br>Great!<br>Keep it to yourself.",
    "Hate criticism and love validation?<br>Go away.<br>You're not welcome here.",
    "Love caps lock?<br>Hate grammar Nazis?<br>Maybe Facebook is for you.",
    "We're not here<br>to spread alleged facts.<br>We discuss reasons.",
    "As the pen is to the sword,<br>so debate is to war.",
];
let aioff_indexes = {};
let aion_indexes = {};
let aioff_scores = {};
let aion_scores = {};
let updated_thresh = -1;


function httpPost(url, payload, callback)
{
    let request = new XMLHttpRequest();
    request.onreadystatechange = function()
    {
        if(request.readyState == 4)
        {
            if(request.status == 200)
                callback(request.responseText);
            else
            {
                if(request.status == 0 && request.statusText.length == 0)
                    alert("Connection failed");
                else
                    alert("Server returned status " + request.status + ", " + request.statusText);
            }
        }
    };
    request.open('post', url, true);
    request.setRequestHeader('Brownie', `sid=${session_id}`)
    request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    request.send(payload);
}

function outgoing(payload)
{
    payload.post = post;
    payload.rev = rev;
    payload.ops = op_list;
    payload.opr = op_revs;
    httpPost("feed_ajax.html", JSON.stringify(payload), incoming);
}

let emojis = [
    'Appreciate',
    'Empathize',
    'Commend',
    'Enjoy',
    'Like',
    'Admire',
    'Acknowledge',
    'Understand',
    'Regard',
    'Agree',
    'Respect',
    'Esteem',
];

function show_react_div(id) {
    let x = document.getElementById(`e.${id}`);
    if (x.style.display === 'inline-block') {
        x.style.display = 'none';
    } else {
        if (x.innerHTML.length == 0) {
            s = [];
            s.push('<table><tr>');
            for (let i = 0; i < 6; i++) {
                s.push(`<td width=100 align=center><a href="#javascript:void(0)" onclick="pick_emoji('${id}', ${i})"><img src="emojis/${emojis[i].toLowerCase()}.png"><br>${emojis[i]}</a></td>`);
            }
            s.push('</tr></tr>')
            for (let i = 6; i < 12; i++) {
                s.push(`<td width=100 align=center><a href="#javascript:void(0)" onclick="pick_emoji('${id}', ${i})"><img src="emojis/${emojis[i].toLowerCase()}.png"><br>${emojis[i]}</a></td>`);
            }
            s.push('</tr></table>');
            s.push(`<button type="button" onclick="closeReact('${id}')">Cancel</button>`);
            s.push('<br><br>');
            x.innerHTML = s.join('');
        }
        x.style.display = 'inline-block';
    }
}

function show_rate_div(id) {
    let x = document.getElementById(`m.${id}`);
    if (x.style.display === 'inline-block') {
        x.style.display = 'none';
    } else {
        if (x.innerHTML.length == 0) {
            s = [];
            s.push('<div class="bubble rate_color">&nbsp;&nbsp<span class="tool">Do not rate positions or claims.');
            s.push('<span class="tool_anchor"><span class="tooltip">Because truth is not identified by popularity. It is found in the pursuit of reasons that can withstand scrutiny.</span></span></span>');
            s.push('<br>&nbsp;&nbsp;Rate the reasons presented to support them.<br>');
            s.push('<table>');
            for (let row = 0; row < 6; row++) {
                s.push('<tr>');
                for (let col = 0; col < 3; col++) {
                    s.push('<td>');
                    let i = 3 * row + col;
                    s.push(`<input type="checkbox" id="m${i}_${id}">`);
                    s.push('<span class="tool">');
                    s.push(`<a class="${i < 4 ? "good" : "bad"}" onclick="rate_one('${id}',${i})" href="javascript:void(0);">`);
                    s.push(`<b>${rating_choices[i]}</b>`);
                    s.push('</a>');
                    s.push(`<span class="tool_anchor"><span class="tooltip">${rating_descr[i]}</span></span>`);
                    s.push('</span>');
                    s.push('</td>');
                }
                s.push('</tr>');
            }
            s.push('</table>');
            s.push(`<button type="button" onclick="submitRatings('${id}')">Rate</button>`);
            s.push(`&nbsp;<button type="button" onclick="closeRatings('${id}')">Cancel</button>`);
            s.push('<br><br></div><br><br>\n');
            x.innerHTML = s.join('');
        }
        x.style.display = 'inline-block';
    }
}

function add_text_area(s, id, rows, maxlen) {
    s.push('<table><tr>');
    s.push(`<td><textarea id="t.${id}" rows="${rows}" cols="60" maxlength="${maxlen}" onkeyup="on_textarea_change(this, 'u.${id}')"></textarea><br>`);
    s.push('<td>');

    // Background
    s.push(`<a onclick="show_upload_background('${id}')" href="javascript:void(0);">background</a><br>`);
    s.push(`<div id="i.${id}" class="hidden">`);
    s.push(`<input id="j.${id}" name="file" type="file" onchange="submit_upload_background('${id}')">`);
    s.push('</div>');

    // Image
    s.push(`<a onclick="show_upload_image('${id}')" href="javascript:void(0);">image</a><br>`);
    s.push(`<div id="b.${id}" class="hidden">`);
    s.push(`<input id="c.${id}" name="file" type="file" onchange="submit_upload_image('${id}')">`);
    s.push('</div>');

    s.push('</td>');
    s.push('</tr></table>');
}

function show_reply_div(id) {
    let x = document.getElementById(`r.${id}`);
    if (x.style.display === 'inline-block') {
        x.style.display = 'none';
    } else {
        if (x.innerHTML.length == 0) {
            s = [];
            s.push('<table><tr><td valign="top">');
            s.push(`<img class="rounded" src="${account_pic}">`);
            s.push('</td><td>');
            add_text_area(s, id, 2, 1000);
            s.push(`<button type="button" onclick="submitReply('${id}')">Post</button>`);
            s.push(`&nbsp;<button type="button" onclick="closeReply('${id}')">Cancel</button>`);
            s.push(`&nbsp;&nbsp;&nbsp;<span id="u.${id}"></span>`);
            s.push('</td></tr></table><br><br>\n');
            x.innerHTML = s.join('');
        }
        x.style.display = 'inline-block';
        let tb = document.getElementById(`t.${id}`);
        tb.focus();
    }
}

function find_or_make_node_div(entry)
{
    // See if the div already exists
    let existing = document.getElementById(`d.${entry.id}`);
    if (existing)
        return existing;

    // Remember this parent-child relationship
    if (!(entry.par in children))
        children[entry.par] = [];
    children[entry.par].push(entry.id);

    // Make the new div
    let nursery_div = document.getElementById(`n.${entry.par}`);
    if (!nursery_div)
        alert(`Received an update for a node I have not yet received: n.${entry.par} for d.${entry.id}`);
    new_div = document.createElement("div");
    new_div.id = `d.${entry.id}`;
    nursery_div.appendChild(new_div);
    return new_div;
}

function node_comparator(a, b)
{
    isaion = document.getElementById('ai_on').checked;
    if (isaion) {
        return aion_scores[a] > aion_scores[b];
    } else {
        return aioff_scores[a] > aioff_scores[b];
    }
}

function update_hint(id)
{
    let hint_div = document.getElementById(`h.${id}`);
    if (hint_div) {
        isaion = document.getElementById('ai_on').checked;
        let index = (isaion ? aion_indexes[id] : aioff_indexes[id]);
        let score = (isaion ? aion_scores[id] : aioff_scores[id]);
        if (score === undefined) {
            hint_div.innerHTML = '';
            console.log('Error, ratings hint was not provided');
        } else if (score >= 1000) {
            hint_div.innerHTML = ''; // unrated
        } else {
            if (index < 4) {
                hint_div.innerHTML = `<font color=#008000>${rating_choices[index]} (${score.toFixed(2)})</font>`;
            } else {
                hint_div.innerHTML = `<font color=#800000>${rating_choices[index]} (${score.toFixed(2)})</font>`;
            }
        }
    } else {
        //console.log(`missing hint div h.${id}`);
    }
}

// Filter which comments are displayed or hidden.
// Update the rating hints.
function refresh_comments(op_id)
{
    thresh = parseInt(document.getElementById(`t.${op_id}`).innerHTML);
    if(!(thresh >= 0 && thresh < 1000)) {
        alert('problem with thresh');
    }
    isaion = document.getElementById('ai_on').checked;
    let q = new PriorityQueue(node_comparator);
    update_hint(op_id);
    kids = children[op_id];
    if (kids === undefined)
        return;
    let op_nursery = document.getElementById(`n.${op_id}`);
    if (thresh === 0) {
        op_nursery.style.display = 'none';
        return;
    }
    op_nursery.style.display = 'block';
    for (let j = 0; j < kids.length; j++) { // For each pod...
        let pod_id = kids[j];
        let grandkids = children[pod_id];
        if (grandkids === undefined)
            continue;

        // Seed the priority queue with the pod's immediate children
        for (let k = 0; k < grandkids.length; k++) {
            let rp_id = grandkids[k];
            q.push(rp_id);
        }

        // Pump in a breadth-first manner
        let nodes_shown = 0;
        while (q.size() > 0 && nodes_shown < thresh) {
            id = q.pop();

            // Update the ratings hint and show the div
            thediv = document.getElementById(`d.${id}`);
            update_hint(id);
            thediv.style.display = 'block';
            nodes_shown++;

            // Add the children
            let nextgen = children[id];
            if (nextgen !== undefined) {
                for (let j = 0; j < nextgen.length; j++) {
                    let child_id = nextgen[j];
                    q.push(child_id);
                }
            }
        } // ...while we haven't yet reached our threshold

        // Hide the remainder
        while (q.size() > 0) {
            let id = q.pop();
            thediv = document.getElementById(`d.${id}`);
            thediv.style.display = 'none';
        }
    } // ...for each pod in the OP
}

function refresh_all_comments()
{
    for (let op_id of op_list) {
        refresh_comments(op_id);
    }
}

function closeReact(id)
{
    let ratingsDiv = document.getElementById(`e.${id}`);
    if (!ratingsDiv)
        console.log(`Error: Missing expected element e.${id}`);
    ratingsDiv.style.display = 'none';
}

function pick_emoji(id, index)
{
    outgoing({
        act: 'react',
        id: id,
        emo: index,
    });
    closeReact(id);
}

function closeRatings(id)
{
    let ratingsDiv = document.getElementById(`m.${id}`);
    if (!ratingsDiv)
        console.log(`Error: Missing expected element m.${id}`);
    ratingsDiv.style.display = 'none';
}

function submitRatings(id)
{
    let ratings = [];
    for (i = 0; i < rating_choices.length; i++) {
        let cb_id = `m${i}_${id}`;
        let cb = document.getElementById(cb_id);
        ratings.push(cb.checked ? 1 : 0);
    }
    outgoing({
        act: 'rate',
        id: id,
        ratings: ratings,
    });
    closeRatings(id);
}

function rate_one(id, index)
{
    let cb_id = `m${index}_${id}`;
    let cb = document.getElementById(cb_id);
    cb.checked = 1;
    submitRatings(id);
}

function del_node(id)
{
    if (!confirm(`Are you sure you want to delete ${id}`))
        return;
    outgoing({
        act: 'del',
        id: id,
    });
}

function closeReply(id)
{
    let replyDiv = document.getElementById(`r.${id}`);
    if (replyDiv)
        replyDiv.style.display = 'none';
}

function submitReply(id)
{
    let text_box = document.getElementById(`t.${id}`);
    let text = text_box.value;
    outgoing({
        act: 'comment',
        parid: id,
        text: text,
    });
    text_box.value = '';
    closeReply(id);
}

function show_upload_background(id)
{
    let el = document.getElementById(`i.${id}`);
    if (el.style.display !== 'inline-block') {
        el.style.display = 'inline-block';
    } else {
        el.style.display = 'none';
    }
}

function show_upload_image(id)
{
    let el = document.getElementById(`b.${id}`);
    if (el.style.display !== 'inline-block') {
        el.style.display = 'inline-block';
    } else {
        el.style.display = 'none';
    }
}

function upload_image(file, act)
{
    let formData = new FormData();
    formData.append('file', file);
    let request = new XMLHttpRequest();
    request.onreadystatechange = function()
    {
        if(request.readyState == 4)
        {
            if(request.status == 200)
                incoming(request.responseText);
            else
            {
                if(request.status == 0 && request.statusText.length == 0)
                    alert("Submit image conneciton failed");
                else
                    alert("Server returned status " + request.status + ", " + request.statusText);
            }
        }
    };
    request.open('POST', 'feed_ajax.html', true);
    request.setRequestHeader('Brownie', `sid=${session_id}`);
    console.log(`action=${act}`);
    request.setRequestHeader('Act', act);
    request.send(formData);
}

function submit_upload_background(id)
{
    active_text_area = document.getElementById(`t.${id}`);
    let bd = document.getElementById(`i.${id}`);
    bd.style.display = 'none';
    let bb = document.getElementById(`j.${id}`);
    if (!bb) {
        console.log('Failed to find the browse button');
        return;
    }
    upload_image(bb.files[0], 'background');
    bb.value = null;
    let el = document.getElementById('upload_image_div');
    el.style.display = 'none';
}

function submit_upload_image(id)
{
    active_text_area = document.getElementById(`t.${id}`);
    let bd = document.getElementById(`b.${id}`);
    bd.style.display = 'none';
    let bb = document.getElementById(`c.${id}`);
    if (!bb) {
        console.log('Failed to find the browse button');
        return;
    }
    upload_image(bb.files[0], 'upload');
    bb.value = null;
    let el = document.getElementById('upload_image_div');
    el.style.display = 'none';
}

function showNotifications()
{
    let el = document.getElementById('notifications');
    if (el.style.display !== 'inline-block') {
        outgoing({
            act: 'notifs',
        });
        el.style.display = 'inline-block';
    } else {
        el.style.display = 'none';
    }
}

function closeNotifs()
{
    let el = document.getElementById('notifications');
    el.style.display = 'none';
}

// pos is the position of notifications already read
// msgs is a list of all the notifications
function update_notifications(pos, msgs)
{
    let el = document.getElementById('notifications');
    let s = [];
    s.push('<div class="notifs">');
    s.push('<h3>Notifications</h3>');
    s.push('<table>');
    if (msgs.length === 0)
        s.push('(No notifications)');
    for (let i = msgs.length - 1; i >= 0; i--)
    {
        let msg = msgs[i];
        if (i >= pos)
            s.push('<tr class="notif_unread">');
        else
            s.push('<tr>');
        s.push('<td>');
        if (msg.image.length > 0)
            s.push(`<img class="rounded" src="${msg.image}">`);
        s.push('</td><td>');
        s.push(msg.name);
        if (msg.type === 'rate')
            s.push(' rated your post, ');
        else if (msg.type === 'rp')
            s.push(' replied to your post, ');
        else if (msg.type === 'op')
            s.push(' participated in your debate, ');
        else if (msg.type === 'chal')
            s.push(' challenged you to debate, ');
        else if (msg.type === 'acc')
            s.push(' accepted your debate challenge, ');
        else if (msg.type.substr(0, 6) === 'react_') {
            let emo = parseInt(msg.type.substr(6));
            if (emo === 0) s.push(' appreciated');
            else if (emo === 1) s.push(' empathized with');
            else if (emo === 2) s.push(' commended');
            else if (emo === 3) s.push(' enjoyed');
            else if (emo === 4) s.push(' liked');
            else if (emo === 5) s.push(' admired');
            else if (emo === 6) s.push(' acknowledged');
            else if (emo === 7) s.push(' understood');
            else if (emo === 8) s.push(' regarded');
            else if (emo === 9) s.push(' agreed with');
            else if (emo === 10) s.push('respected');
            else if (emo === 11) s.push(' esteemed');
            else console.log(`invalid emo index: ${emo}`);
            s.push(' your post, ');
        }
        else
            console.log(`Error, unrecognized notification ${msg.type}`);
        s.push(`<a href='?post=${msg.id}'>${msg.summ}</a>`);
        s.push('</td></tr>');
    }
    s.push('</table>');
    s.push('<br><button type="button" onclick="closeNotifs()">Close</button>');
    s.push('</div>');
    el.innerHTML = s.join('');
}

function ai_on()
{
    el = document.getElementById('ai_on');
    el.checked = true;
}

function ai_off()
{
    el = document.getElementById('ai_off');
    el.checked = true;
}

function startNewDebate(id)
{
    let sel = document.getElementById('choose_opponent');
    let mode = sel.value;
    let text_box = document.getElementById(`t.${id}`);
    let text = text_box.value;
    let packet = {
        act: 'newop',
        parid: post,
        mode: mode,
        text: text,
    };
    if (mode === 'name') {
        let opponent_name = document.getElementById('opponent');
        packet.name = opponent_name.value;
    }
    outgoing(packet);
    text_box.value = '';
}

function accept_challenge(pod_id)
{
    outgoing({
        act: 'accept',
        id: pod_id,
    });
}

function add_emo(id, emo, name)
{
    // Create an emo span
    let emo_display = document.getElementById(`f.${id}`);
    let emo_span = document.createElement("span");
    emo_span.className = 'tool';
    let s = [];
    s.push(`<img src="emojis/${emojis[emo].toLowerCase()}.png" height=24>`);
    s.push(`<span class="tool_anchor"><span class="tooltip">From: ${name}</span></span>`);
    emo_span.innerHTML = s.join('');

    // Add the emo span (bumping off the first one if needed)
    if (emo_display.children.length >= 8) {
        emo_display.children[0].remove();
    }
    emo_display.appendChild(emo_span);
}

// ID Prefixes:
// b = enclosing div for the browse button for uploading an image
// c = browse button for uploading an image
// d = node
// e = emoji choices
// f = emoji display
// h = hint about rating
// i = enclosing div for the browse button for uploading a background
// j = browse button for uploading a background
// m = moderation div
// n = nursery (div for child nodes)
// r = reply div
// s = slider div
// t = slider text
// u = reply text area counter


// s is an array of strings
// entry is an object that describes the entry
function add_rate_and_respond_links(s, entry, allow_reply)
{
    s.push('<div class="hovermenulink">');

    if (entry.name !== account_name) {
        // React
        s.push('<span class="tool">');
        s.push(`<a href="#javascript:void(0)" onclick="show_react_div('${entry.id}')">thank</a><br>`);
        s.push(`<span class="tool_anchor"><span class="tooltip">Express a positive emotion for the author. (The author will be notified about your reaction. Our A.I. will not be informed.)</span></span>`);
        s.push('</span>');
    }

    // Reply
    if (allow_reply) {
        s.push('<span class="tool">');
        s.push(`<a href="#javascript:void(0)" onclick="show_reply_div('${entry.id}')">reply</a><br>`);
        s.push(`<span class="tool_anchor"><span class="tooltip">Compose a response</span></span>`);
        s.push('</span>');
    }

    s.push('<div class="hovermenu">'); // Everything below this line will appear when the mouse hovers over one of the links above

    if (entry.name !== account_name) {
        // Moderate
        s.push('<span class="tool">');
        s.push(`<a href="#javascript:void(0)" onclick="show_rate_div('${entry.id}')">rate</a><br>`);
        s.push('<span class="tool_anchor"><span class="tooltip">');
        s.push(`<div id='h.${entry.id}'></div><br><br>`);
        s.push('If your opinion differs from the rating above, please consider rating this post. Your ratings help our A.I. determine which posts to show others who make similar ratings. ');
        s.push('Only the A.I. will receive your ratings. The author will not be informed who rated the post.');
        s.push('</span></span>');
        s.push('</span>');
    }

    // Link
    s.push('<span class="tool">');
    s.push(`<a href="?post=${entry.id}" onclick="return copy_text('${crop_params(window.location.href)}?post=${entry.id}')">link</a><br>`);
    s.push(`<span class="tool_anchor"><span class="tooltip">Click to copy a direct link to this post into the clipboard. You can paste it wherever you want to reference this post.</span></span>`);
    s.push('</span>');

    // Delete
    if (admin) {
        s.push(`<a href="#javascript:void(0)" onclick="del_node('${entry.id}')">delete</a><br>`);
    }

    s.push('</div></div>');
}

// newDiv is a div to hold the content this function generates.
// entry is an update object from the server.
function make_cat(newDiv, entry)
{
    let s = [];
    s.push(`<img src='spacer.png' width=${40*entry.dep}px height=1px>`);
    s.push('<big><big>');
    if (entry.dep > 0) {
        s.push('└─');
    }
    s.push(`<a href='?post=${entry.id}'>${entry.text}</a>\n`);
    s.push('</big></big><br>');

    // Add the new OP area
    if (entry.nop) {
        s.push('<br><br><h3>Start a new debate:</h3>');
        s.push('(The best debate topics make <u>one</u> claim and provide <u>one</u> supporting reason.)<br>');
        add_text_area(s, entry.id, 4, 1500);
        s.push('<br>Who would you like to challenge to debate?<br>');
        s.push('<select id="choose_opponent" onchange="on_change_opponent()">');
        s.push('<option value="open">No one--let\'s just have an open discussion</option>');
        s.push('<option value="first">Whomever first accepts the challenge</option>');
        s.push('<option value="name">The individual named below</option>');
        s.push('</select><br>');
        s.push('<div id="opponent_name_div" class="hidden">');
        s.push('<input type="text" id="opponent"><br>');
        s.push('</div><br>');
        s.push(`<button type="button" onclick="startNewDebate('${entry.id}')">Post</button>`);
        s.push('<br><br><br><br>');
    }

    s.push(`<div id="n.${entry.id}"></div>\n`);
    newDiv.innerHTML = s.join('');
}

// newDiv is a div to hold the content this function generates.
// entry is an update object from the server.
function make_op(newDiv, entry)
{
    newDiv.className = 'op';
    let s = [];
    s.push('<table><tr>');
    s.push(`<td valign=top align=right><img class="rounded" src="${entry.image}">`);
    s.push('</td><td width=4px></td>');
    s.push(`<td><p><b><a href='accounts.html?id=${entry.aid}'>${entry.name}</a></b>&nbsp;&nbsp;<span id='f.${entry.id}'></span><br>`);
    s.push(`<big><big>${entry.text}</big></big></p></td>`);
    s.push('<td valign=top>');
    add_rate_and_respond_links(s, entry, false);
    s.push('</td>');
    s.push('</tr></table>');
    s.push(`<div class="hidden" id="e.${entry.id}"></div>`);
    s.push(`<div class="hidden" id="m.${entry.id}"></div>`);
    s.push(`<table><tr><td><div id="s.${entry.id}"></div></td><td>Show the top <span id="t.${entry.id}">0</span> comments</td></tr></table>`);
    s.push(`<div id="n.${entry.id}"></div>`);
    newDiv.innerHTML = s.join('');

    // Display the emojis that have been attached to this post
    for (emo of entry.emos) {
        add_emo(entry.id, emo[0], emo[1]);
    }

    // Activate the slider
    let op_slider = new Slider(`s.${entry.id}`, 'slider_bg.png', 321, 22, 'slider_tab.png', 19, 20, 25, on_slider_change);
    op_slider.id = entry.id;
    op_slider.set_value(0);
}

function make_pod(newDiv, entry)
{
    let s = [];
    s.push('<table><tr><td>');
    s.push('<table cellpadding=10px><tr>');
    s.push('<td valign=top>');
    s.push('<span class="tool">');
    s.push(`<h3>${entry.text}</h3>`);
    s.push('<span class="tool_anchor"><span class="tooltip">');
    if (entry.text === 'Open discussion')
        s.push('Everyone is welcome to participate in this discussion.');
    else if (entry.text === 'One-on-one debate')
        s.push('Only the two debaters may post here. Others should comment in the peanut gallery.');
    else if (entry.text === 'Peanut gallery')
        s.push('A place where anyone may post comments.');
    s.push('</span></span></span>');
    s.push('</td>');
    s.push('</tr></table>');
    s.push('</td></tr></table>\n');
    s.push(`<div class="indent" id="n.${entry.id}"></div>\n`);
    if (entry.ro === undefined) {
        s.push('<div class="indent">');
        s.push('<table><tr><td valign="top">');
        s.push(`<img class="rounded" src="${account_pic}">`);
        s.push('</td><td>');
        s.push(`<textarea id="t.${entry.id}" rows="2" cols="50" maxlength="1000" onkeyup="on_textarea_change(this, 'u.${entry.id}')"></textarea><br>`);
        s.push(`<button type="button" onclick="submitReply('${entry.id}')">Post</button>`);
        s.push(`&nbsp;&nbsp;&nbsp;<span id="u.${entry.id}"></span>`);
        s.push('</td></tr></table></div>');
        s.push('<br><br>\n');
    } else {
        if (entry.ro == 1) {
            s.push(`<br><div class="indent"><button type="button" onclick="accept_challenge('${entry.id}')">Accept this challenge</button></div></br>`);
        }
    }
    newDiv.innerHTML = s.join('');
}

// newDiv is a div to hold the content this function generates.
// entry is an update object from the server.
function make_rp(newDiv, entry)
{
    let s = [];
    let open_pod = (entry.ind === undefined ? true : false);

    s.push('<table><tr>');
    if (!open_pod) {
        let indent = (entry.ind !== 0);
        if (indent) {
            s.push('<td width="150px"></td>')
        }
    }
    s.push('<td>');
    s.push('<div class="bubble rp_color"><table><tr>');

    if (open_pod) {
        // Peanut gallery comment
        s.push(`<td valign=top align=right><img class="rounded" src="${entry.image}"></td><td width=4px></td>`);
        s.push('<td valign=top><p>');
        s.push(`<b><a href='accounts.html?id=${entry.aid}'>${entry.name}</a></b>&nbsp;&nbsp;<span id='f.${entry.id}'></span>`);
        s.push('<br>');
        s.push(entry.text);
        s.push('</p></td>');
    } else {
        // One-on-one debate comment
        let image_on_left = (entry.ind === 0 ? true : false)
        if (image_on_left)
            s.push(`<td valign=top align=right><img class="rounded" src="${entry.image}"></td><td width=4px></td>`);
        s.push('<td valign=top><p>');
        s.push(`<b><a href='accounts.html?id=${entry.aid}'>${entry.name}</a></b>&nbsp;&nbsp;<span id='f.${entry.id}'></span>`);
        s.push('<br>');
        s.push(entry.text);
        s.push('</p></td>');
        if (!image_on_left)
            s.push(`<td width=4px></td><td valign=top align=right><img class="rounded" src="${entry.image}"></td>`);
    }

    s.push('</tr></table></div>');
    s.push('</td><td valign=top>');
    add_rate_and_respond_links(s, entry, open_pod);
    s.push('</td></tr></table>\n');
    s.push(`<div class="hidden" id="e.${entry.id}"></div>\n`);
    s.push(`<div class="hidden" id="m.${entry.id}"></div>\n`);
    s.push(`<div class="indent" id="n.${entry.id}"></div>\n`);
    if (open_pod) {
        s.push(`<div class="hidden indent" id="r.${entry.id}"></div>\n`);
    }
    newDiv.innerHTML = s.join('');

    // Display the emojis that have been attached to this post
    for (emo of entry.emos) {
        add_emo(entry.id, emo[0], emo[1]);
    }
}

function store_ratings(entry)
{
    if (entry.ui !== undefined) {
        aioff_indexes[entry.id] = entry.ui;
        aion_indexes[entry.id] = entry.bi;
        aioff_scores[entry.id] = entry.us;
        aion_scores[entry.id] = entry.bs;
    }
}

function add_node(entry)
{
    let newDiv = find_or_make_node_div(entry);
    if (!newDiv) {
        console.log(`Ignoring irrelevant update to ${entry.id}`);
        return;
    }

    // Store ratings for the node
    store_ratings(entry);

    // Fill out the div content
    if (entry.type === 'rp') {
        make_rp(newDiv, entry);
        if (entry.id == post) {
            newDiv.scrollIntoView();
        }
    } else if (entry.type === 'pod') {
        make_pod(newDiv, entry);
    } else if (entry.type === 'op') {
        make_op(newDiv, entry);
    } else if (entry.type === 'cat') {
        make_cat(newDiv, entry);
    } else {
        let msg = `unrecognized entry type ${entry.type}`;
        alert(msg);
        throw msg;
    }
}

// Add a new OP to the list of OPs
function add_op(entry)
{
    op_list.splice(0, 0, entry.id); // insert entry.id at the front of the list
}

function set_focus(id)
{
    let node = document.getElementById(`d.${id}`);
    node.style.backgroundColor = '#ffff00';
    setTimeout(function() { node.style.backgroundColor = ''; }, 400);
    //node.scrollIntoView();
}

function insert_textarea_snip(insert_me)
{
    if (!active_text_area) {
        console.log(`No active text area for inserting text: ${insert_me}`);
        alert(`No active text area for inserting text: ${insert_me}`);
        return;
    }
    if (active_text_area.selectionStart || active_text_area.selectionStart == '0') {
        active_text_area.value = active_text_area.value.substring(0, active_text_area.selectionStart)
            + insert_me
            + active_text_area.value.substring(active_text_area.selectionEnd, active_text_area.value.length);
    } else {
        active_text_area.value += insert_me;
    }
}

function on_receive_background_image(filename)
{
    insert_textarea_snip(`<div style="background-image:url('${filename}')">Your text here</div>`);
}

function on_receive_uploaded_image(filename)
{
    insert_textarea_snip(`<img src="${filename}">`);
}

// Returns true iff a show/hide pass should be performed
function update_entry(entry)
{
    if (entry.act === 'add') {
        add_node(entry);
        return true;
    } else if (entry.act === 'emo') {
        add_emo(entry.id, entry.emo, entry.name);
        return false;
    } else if (entry.act === 'focus') {
        let id = entry.id;
        setTimeout(function() { set_focus(id); }, 200); // a little delay b/c the new comment may not be added yet
        return false;
    } else if (entry.act === 'rate') {
        store_ratings(entry);
        return true;
    } else if (entry.act === 'pushop') { // server wants to push an OP on us. (It's probably a new OP we just requested to have created.)
        add_op(entry);
        init();
        return true;
    } else if (entry.act === 'alert') { // Display a message from the server
        alert(entry.msg);
        return false;
    } else if (entry.act === 'notifs') { // Notifications
        update_notifications(entry.pos, entry.msgs);
        return false;
    } else if (entry.act === 'nc') {
        let notif_count_div = document.getElementById('notif_count');
        if (entry.val === 0)
            notif_count_div.innerHTML = "";
        else
            notif_count_div.innerHTML = `<font color="yellow">(${entry.val})</font>`;
        return false;
    } else if (entry.act === 'upload') {
        on_receive_uploaded_image(entry.file);
    } else if (entry.act === 'background') {
        on_receive_background_image(entry.file);
    } else {
        let msg = `unrecognized action ${entry.act}`;
        alert(msg);
        throw msg;
    }
}

function request_updates()
{
    outgoing({ act: 'update' });
}

function incoming(response)
{
    let ob = JSON.parse(response);
    if (ob.updates === undefined) {
        alert(`No updates in ${JSON.stringify(ob)}`);
    }
    let changed_posts = false;
    for(entry of ob.updates) {
        if(update_entry(entry)) // Receive new updates
            changed_posts = true;
    }
    if (ob.rev !== undefined) {
        rev = ob.rev;
        op_list = ob.ops;
        op_revs = ob.opr;
    }
    if (changed_posts) {
        refresh_all_comments(); // Determine which comments to show or hide, and add rating information
    }
}

function on_change_opponent()
{
    console.log('changing opponent');
    let sel = document.getElementById('choose_opponent');
    let opponent_name = document.getElementById('opponent_name_div');
    let val = sel.value;
    console.log(val);
    if (val === 'name') {
        console.log('showing opponent');
        opponent_name.style.display = 'inline-block';
    } else {
        console.log('hiding opponent');
        opponent_name.style.display = 'none';
    }
}

function on_change_aion()
{
    refresh_all_comments();
    outgoing({
        act: 'change_aion',
        on: document.getElementById('ai_on').checked,
    });
}

function on_slider_change(slider, val)
{
    let op_id = slider.id;
    if (op_id === undefined)
        return;
    tb = document.getElementById(`t.${op_id}`);
    if(tb) {
        tb.innerHTML = '' + val;
        refresh_comments(op_id);
    }
    updated_thresh = val;
    setTimeout(function() {
        // If the threshold hasn't changed for a while, tell the server about it
        if (updated_thresh === val) {
            outgoing({
                act: 'change_thresh',
                val: val,
            });
        }
    }, 1000);
}

function on_textarea_change(textarea, counter_id)
{
    active_text_area = textarea;
    // if (comment_count * 2 >= rating_count && textarea.value.length % 10 == 0) {
    //     alert(`Sorry, you have rated ${rating_count} comments and have posted ${comment_count}.\nA 2:1 ratio is required, so you must rate more comments before you may post.`);
    // }
    let count_span = document.getElementById(counter_id);
    chars_remaining = textarea.maxLength - textarea.value.length;
    count_span.innerHTML = chars_remaining < 500 ? chars_remaining : '';
}

function crop_params(url)
{
    let n = url.indexOf('?');
    if (n < 0) {
        return url;
    } else {
        return url.substr(0, n);
    }
}

function copy_text(str)
{
    let tempInput = document.createElement("input");
    tempInput.style = "position: absolute; left: -1000px; top: -1000px";
    tempInput.value = str;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand("copy");
    document.body.removeChild(tempInput);
    return false; // don't follow the link
}

function init()
{
    // Set the tag line
    let tagline = document.getElementById('tagline');
    tagline.innerHTML = tag_lines[Math.floor(Math.random() * tag_lines.length)];

    // Show the account link
    let account_name_span = document.getElementById('account_name');
    account_name_span.innerHTML = `<b>${account_name}</b>`;
    let account_pic_span = document.getElementById('account_pic');
    account_pic_span.innerHTML = `<img class="rounded" src="${account_pic}">`;

    // Show or hide the ai on/off controls
    if (rating_count > 10) {
        if (initial_ai_on) {
            document.getElementById('ai_on').checked = true;
        } else {
            document.getElementById('ai_off').checked = true;
        }
        let ai_switch = document.getElementById('ai_switch');
        ai_switch.style.display = 'inline-block';
    }

    // Pull the content
    rev = 0;
    op_revs = [];
    for (let p of op_list) {
        op_revs.push(0);
    }
    request_updates();
}
</script>

</head><body>
<br><br>
<table bgcolor=#dddddd width=800 align=center><tr><td>

<div class="header">
    <table width="100%"><tr>
        <td width=330>
            <big><big><big><big>DebateStuff.com</big></big></big></big><br>
            <div id='tagline'></div>
        </td>
        <td>
            <span class="tool">
                <a onclick="showNotifications()" href="javascript:void(0);"><img src="starter_pics/bell.png"><span id="notif_count"></span></a>
                <span class="tool_anchor"><span class="tooltip">Show your notifications</span></span>
            </span>
            &nbsp;&nbsp;&nbsp;
            <span class="tool">
                <a href="handbook.html"><img src="starter_pics/book.png"></a>
                <span class="tool_anchor"><span class="tooltip">Show the handbook</span></span>
            </span>
            &nbsp;&nbsp;&nbsp;
            <span class="tool">
                <a href="accounts.html"><span id="account_pic"></span></a>
                <span class="tool_anchor"><span class="tooltip"><span id="account_name"></span><br>View or edit your account details</span></span>
            </span>
            <br>
            <div id="ai_switch" class="hidden">
                A.I.:<br>
                <span class="tool">
                    <input type="radio" id="ai_off" name="isaion" onchange="on_change_aion();" checked>
                    <span onclick="ai_off()" style="cursor: pointer;">Off</span>
                    <span class="tool_anchor"><span class="tooltip">When our A.I. is turned <b>off</b>, we show the top comments according to the overall community ratings.<br><br>(Our A.I. will still learn from your ratings, if you do any, but we won't use the A.I. to decide which posts to show you.)</span></span>
                </span>
                <span class="tool">
                    <input type="radio" id="ai_on" name="isaion" onchange="on_change_aion();">
                    <span onclick="ai_on()" style="cursor: pointer;">On</span>
                    <span class="tool_anchor"><span class="tooltip">When our A.I. is turned <b>on</b>, we show the comments that our A.I. predicts you would rate most highly.<br><br>(Don't be scared. He's a nice A.I. who doesn't watch you when you leave our site. And he doesn't watch you while you sleep at night either--that would be creepy.)</span></span>
                </span>
            </div>
        </td>
    </tr></table>

    <div id='notifications' class='hidden'>
    </div>
</div>

<div id='n.'></div>
</td></tr></table>
<input type='hidden' id='clipboard_helper'>
<br><br><br><br><br><br><br><br>
<br><br><br><br><br><br><br><br>
<br><br><br><br><br><br><br><br>

<script type="text/javascript">
init();
let timer = setInterval(function() { request_updates(); }, 5000);
</script>

</body></html>
